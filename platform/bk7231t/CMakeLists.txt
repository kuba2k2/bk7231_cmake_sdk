cmake_minimum_required(VERSION 3.17)

project(bk7231t_sdk C ASM)

set(SOURCES "")
set(SOURCES_RTOS "")
set(INCLUDES "")
set(ASM "")

# Sources lists built from
# https://github.com/tuya/tuya-iotos-embeded-sdk-wifi-ble-bk7231t/blob/master/platforms/bk7231t/bk7231t_os/application.mk
list(APPEND SOURCES "app/app_bk.c" "app/ate_app.c" "app/config/param_config.c" "app/standalone-ap/sa_ap.c" "app/standalone-station/sa_station.c" "demo/ieee802_11_demo.c" "driver/common/dd.c" "driver/common/drv_model.c" "driver/dma/dma.c" "driver/driver.c" "driver/entry/arch_main.c" "driver/fft/fft.c" "driver/flash/flash.c" "driver/general_dma/general_dma.c" "driver/gpio/gpio.c" "driver/i2s/i2s.c" "driver/icu/icu.c" "driver/intc/intc.c" "driver/irda/irda.c" "driver/macphy_bypass/mac_phy_bypass.c" "driver/phy/phy_trident.c" "driver/pwm/pwm.c" "driver/pwm/mcu_ps_timer.c" "driver/pwm/bk_timer.c" "driver/rw_pub/rw_platf_pub.c" "driver/saradc/saradc.c" "driver/spi/spi.c" "driver/spidma/spidma.c" "driver/sys_ctrl/sys_ctrl.c" "driver/uart/Retarget.c" "driver/uart/uart_bk.c" "driver/wdt/wdt.c" "driver/ble/ble.c" "driver/ble/ble_pub/ip/ble/hl/src/prf/prf.c" "driver/ble/ble_pub/ip/ble/profiles/sdp/src/sdp_service.c" "driver/ble/ble_pub/ip/ble/profiles/sdp/src/sdp_service_task.c" "driver/ble/ble_pub/ip/ble/profiles/comm/src/comm.c" "driver/ble/ble_pub/ip/ble/profiles/comm/src/comm_task.c" "driver/ble/ble_pub/modules/app/src/app_ble.c" "driver/ble/ble_pub/modules/app/src/app_task.c" "driver/ble/ble_pub/modules/app/src/app_sdp.c" "driver/ble/ble_pub/modules/app/src/app_sec.c" "driver/ble/ble_pub/modules/app/src/app_comm.c" "driver/ble/ble_pub/modules/common/src/common_list.c" "driver/ble/ble_pub/modules/common/src/common_utils.c" "driver/ble/ble_pub/modules/common/src/RomCallFlash.c" "driver/ble/ble_pub/modules/dbg/src/dbg.c" "driver/ble/ble_pub/modules/dbg/src/dbg_mwsgen.c" "driver/ble/ble_pub/modules/dbg/src/dbg_swdiag.c" "driver/ble/ble_pub/modules/dbg/src/dbg_task.c" "driver/ble/ble_pub/modules/rwip/src/rwip.c" "driver/ble/ble_pub/modules/rf/src/ble_rf_xvr.c" "driver/ble/ble_pub/modules/ecc_p256/src/ecc_p256.c" "driver/ble/ble_pub/plf/refip/src/driver/uart/uart.c" "func/func.c" "func/bk7011_cal/bk7231U_cal.c" "func/bk7011_cal/manual_cal_bk7231U.c" "func/joint_up/role_launch.c" "func/hostapd_intf/hostapd_intf.c" "func/hostapd-2.5/bk_patch/ddrv.c" "func/hostapd-2.5/bk_patch/signal.c" "func/hostapd-2.5/bk_patch/sk_intf.c" "func/hostapd-2.5/bk_patch/fake_socket.c" "func/hostapd-2.5/hostapd/main_none.c" "func/hostapd-2.5/src/crypto/aes-internal.c" "func/hostapd-2.5/src/crypto/aes-internal-dec.c" "func/hostapd-2.5/src/crypto/aes-internal-enc.c" "func/hostapd-2.5/src/crypto/aes-unwrap.c" "func/hostapd-2.5/src/crypto/aes-wrap.c" "func/hostapd-2.5/src/crypto/bk_md5.c" "func/hostapd-2.5/src/crypto/md5-internal.c" "func/hostapd-2.5/src/crypto/rc4.c" "func/hostapd-2.5/src/crypto/bk_sha1.c" "func/hostapd-2.5/src/crypto/sha1-internal.c" "func/hostapd-2.5/src/crypto/sha1-pbkdf2.c" "func/hostapd-2.5/src/crypto/sha1-prf.c" "func/hostapd-2.5/src/crypto/tls_none.c" "func/hostapd-2.5/src/ap/ap_config.c" "func/hostapd-2.5/src/ap/ap_drv_ops.c" "func/hostapd-2.5/src/ap/ap_list.c" "func/hostapd-2.5/src/ap/ap_mlme.c" "func/hostapd-2.5/src/ap/beacon.c" "func/hostapd-2.5/src/ap/drv_callbacks.c" "func/hostapd-2.5/src/ap/hostapd.c" "func/hostapd-2.5/src/ap/hw_features.c" "func/hostapd-2.5/src/ap/ieee802_11_auth.c" "func/hostapd-2.5/src/ap/ieee802_11.c" "func/hostapd-2.5/src/ap/ieee802_11_ht.c" "func/hostapd-2.5/src/ap/ieee802_11_shared.c" "func/hostapd-2.5/src/ap/ieee802_1x.c" "func/hostapd-2.5/src/ap/sta_info.c" "func/hostapd-2.5/src/ap/tkip_countermeasures.c" "func/hostapd-2.5/src/ap/utils.c" "func/hostapd-2.5/src/ap/wmm.c" "func/hostapd-2.5/src/ap/wpa_auth.c" "func/hostapd-2.5/src/ap/wpa_auth_glue.c" "func/hostapd-2.5/src/ap/wpa_auth_ie.c" "func/hostapd-2.5/src/common/hw_features_common.c" "func/hostapd-2.5/src/common/ieee802_11_common.c" "func/hostapd-2.5/src/common/wpa_common.c" "func/hostapd-2.5/src/drivers/driver_beken.c" "func/hostapd-2.5/src/drivers/driver_common.c" "func/hostapd-2.5/src/drivers/drivers.c" "func/hostapd-2.5/src/l2_packet/l2_packet_none.c" "func/hostapd-2.5/src/rsn_supp/wpa.c" "func/hostapd-2.5/src/rsn_supp/wpa_ie.c" "func/hostapd-2.5/src/utils/common.c" "func/hostapd-2.5/src/utils/eloop.c" "func/hostapd-2.5/src/utils/os_none.c" "func/hostapd-2.5/src/utils/wpabuf.c" "func/hostapd-2.5/wpa_supplicant/blacklist.c" "func/hostapd-2.5/wpa_supplicant/bss.c" "func/hostapd-2.5/wpa_supplicant/config.c" "func/hostapd-2.5/wpa_supplicant/config_none.c" "func/hostapd-2.5/wpa_supplicant/events.c" "func/hostapd-2.5/wpa_supplicant/main_supplicant.c" "func/hostapd-2.5/wpa_supplicant/notify.c" "func/hostapd-2.5/wpa_supplicant/wmm_ac.c" "func/hostapd-2.5/wpa_supplicant/wpa_scan.c" "func/hostapd-2.5/wpa_supplicant/wpas_glue.c" "func/hostapd-2.5/wpa_supplicant/wpa_supplicant.c" "func/lwip_intf/lwip-2.0.2/port/ethernetif.c" "func/lwip_intf/lwip-2.0.2/port/net.c" "func/lwip_intf/lwip-2.0.2/port/sys_arch.c" "func/lwip_intf/lwip-2.0.2/src/api/api_lib.c" "func/lwip_intf/lwip-2.0.2/src/api/api_msg.c" "func/lwip_intf/lwip-2.0.2/src/api/err.c" "func/lwip_intf/lwip-2.0.2/src/api/netbuf.c" "func/lwip_intf/lwip-2.0.2/src/api/netdb.c" "func/lwip_intf/lwip-2.0.2/src/api/netifapi.c" "func/lwip_intf/lwip-2.0.2/src/api/sockets.c" "func/lwip_intf/lwip-2.0.2/src/api/tcpip.c" "func/lwip_intf/lwip-2.0.2/src/core/def.c" "func/lwip_intf/lwip-2.0.2/src/core/dns.c" "func/lwip_intf/lwip-2.0.2/src/core/inet_chksum.c" "func/lwip_intf/lwip-2.0.2/src/core/init.c" "func/lwip_intf/lwip-2.0.2/src/core/ip.c" "func/lwip_intf/lwip-2.0.2/src/core/ipv4/autoip.c" "func/lwip_intf/lwip-2.0.2/src/core/ipv4/dhcp.c" "func/lwip_intf/lwip-2.0.2/src/core/ipv4/etharp.c" "func/lwip_intf/lwip-2.0.2/src/core/ipv4/icmp.c" "func/lwip_intf/lwip-2.0.2/src/core/ipv4/igmp.c" "func/lwip_intf/lwip-2.0.2/src/core/ipv4/ip4_addr.c" "func/lwip_intf/lwip-2.0.2/src/core/ipv4/ip4.c" "func/lwip_intf/lwip-2.0.2/src/core/ipv4/ip4_frag.c" "func/lwip_intf/lwip-2.0.2/src/core/ipv6/dhcp6.c" "func/lwip_intf/lwip-2.0.2/src/core/ipv6/ethip6.c" "func/lwip_intf/lwip-2.0.2/src/core/ipv6/icmp6.c" "func/lwip_intf/lwip-2.0.2/src/core/ipv6/inet6.c" "func/lwip_intf/lwip-2.0.2/src/core/ipv6/ip6_addr.c" "func/lwip_intf/lwip-2.0.2/src/core/ipv6/ip6.c" "func/lwip_intf/lwip-2.0.2/src/core/ipv6/ip6_frag.c" "func/lwip_intf/lwip-2.0.2/src/core/ipv6/mld6.c" "func/lwip_intf/lwip-2.0.2/src/core/ipv6/nd6.c" "func/lwip_intf/lwip-2.0.2/src/core/mem.c" "func/lwip_intf/lwip-2.0.2/src/core/memp.c" "func/lwip_intf/lwip-2.0.2/src/core/netif.c" "func/lwip_intf/lwip-2.0.2/src/core/pbuf.c" "func/lwip_intf/lwip-2.0.2/src/core/raw.c" "func/lwip_intf/lwip-2.0.2/src/core/stats.c" "func/lwip_intf/lwip-2.0.2/src/core/sys.c" "func/lwip_intf/lwip-2.0.2/src/core/tcp.c" "func/lwip_intf/lwip-2.0.2/src/core/tcp_in.c" "func/lwip_intf/lwip-2.0.2/src/core/tcp_out.c" "func/lwip_intf/lwip-2.0.2/src/core/timeouts.c" "func/lwip_intf/lwip-2.0.2/src/core/udp.c" "func/lwip_intf/lwip-2.0.2/src/netif/ethernet.c" "func/lwip_intf/dhcpd/dhcp-server.c" "func/lwip_intf/dhcpd/dhcp-server-main.c" "func/misc/fake_clock.c" "func/misc/target_util.c" "func/misc/start_type.c" "func/power_save/power_save.c" "func/power_save/manual_ps.c" "func/power_save/mcu_ps.c" "func/rf_test/rx_sensitivity.c" "func/rf_test/tx_evm.c" "func/rwnx_intf/rw_ieee80211.c" "func/rwnx_intf/rw_msdu.c" "func/rwnx_intf/rw_msg_rx.c" "func/rwnx_intf/rw_msg_tx.c" "func/sim_uart/gpio_uart.c" "func/sim_uart/pwm_uart.c" "func/spidma_intf/spidma_intf.c" "func/temp_detect/temp_detect.c" "func/uart_debug/cmd_evm.c" "func/uart_debug/cmd_help.c" "func/uart_debug/cmd_reg.c" "func/uart_debug/cmd_rx_sensitivity.c" "func/uart_debug/command_line.c" "func/uart_debug/command_table.c" "func/uart_debug/udebug.c" "func/user_driver/BkDriverFlash.c" "func/user_driver/BkDriverRng.c" "func/user_driver/BkDriverGpio.c" "func/user_driver/BkDriverPwm.c" "func/user_driver/BkDriverUart.c" "func/user_driver/BkDriverWdg.c" "func/user_driver/BkDriverTimer.c" "func/wlan_ui/wlan_cli.c" "func/wlan_ui/wlan_ui.c" "func/tuya_pwm/tuya_pwm.c" "os/mem_arch.c" "os/str_arch.c")
list(APPEND SOURCES_RTOS "os/FreeRTOSv9.0.0/FreeRTOS/Source/croutine.c" "os/FreeRTOSv9.0.0/FreeRTOS/Source/event_groups.c" "os/FreeRTOSv9.0.0/FreeRTOS/Source/list.c" "os/FreeRTOSv9.0.0/FreeRTOS/Source/portable/Keil/ARM968es/port.c" "os/FreeRTOSv9.0.0/FreeRTOS/Source/portable/MemMang/heap_4.c" "os/FreeRTOSv9.0.0/FreeRTOS/Source/queue.c" "os/FreeRTOSv9.0.0/FreeRTOS/Source/tasks.c" "os/FreeRTOSv9.0.0/FreeRTOS/Source/timers.c" "os/FreeRTOSv9.0.0/rtos_pub.c")
list(APPEND INCLUDES "common" "app" "app/config" "app/standalone-station" "app/standalone-ap" "ip/common" "ip/ke/" "ip/mac/" "ip/lmac/src/hal" "ip/lmac/src/mm" "ip/lmac/src/ps" "ip/lmac/src/rd" "ip/lmac/src/rwnx" "ip/lmac/src/rx" "ip/lmac/src/scan" "ip/lmac/src/sta" "ip/lmac/src/tx" "ip/lmac/src/vif" "ip/lmac/src/rx/rxl" "ip/lmac/src/tx/txl" "ip/lmac/src/p2p" "ip/lmac/src/chan" "ip/lmac/src/td" "ip/lmac/src/tpc" "ip/lmac/src/tdls" "ip/umac/src/mesh" "ip/umac/src/rc" "ip/umac/src/apm" "ip/umac/src/bam" "ip/umac/src/llc" "ip/umac/src/me" "ip/umac/src/rxu" "ip/umac/src/scanu" "ip/umac/src/sm" "ip/umac/src/txu" "driver/include" "driver/common/reg" "driver/entry" "driver/dma" "driver/intc" "driver/phy" "driver/rc_beken" "driver/flash" "driver/rw_pub" "driver/common/reg" "driver/common" "driver/uart" "driver/sys_ctrl" "driver/gpio" "driver/general_dma" "driver/spidma" "driver/icu" "driver/ble" "driver/ble/ble_pub/ip/ble/hl/inc" "driver/ble/ble_pub/ip/ble/profiles/sdp/api" "driver/ble/ble_pub/ip/ble/profiles/comm/api" "driver/ble/ble_pub/modules/rwip/api" "driver/ble/ble_pub/modules/app/api" "driver/ble/ble_pub/modules/common/api" "driver/ble/ble_pub/modules/dbg/api" "driver/ble/ble_pub/modules/rwip/api" "driver/ble/ble_pub/modules/rf/api" "driver/ble/ble_pub/modules/ecc_p256/api" "driver/ble/ble_pub/plf/refip/src/arch" "driver/ble/ble_pub/plf/refip/src/arch/boot" "driver/ble/ble_pub/plf/refip/src/arch/compiler" "driver/ble/ble_pub/plf/refip/src/arch/ll" "driver/ble/ble_pub/plf/refip/src/arch" "driver/ble/ble_pub/plf/refip/src/build/ble_full/reg/fw" "driver/ble/ble_pub/plf/refip/src/driver/reg" "driver/ble/ble_pub/plf/refip/src/driver/ble_icu" "driver/ble/ble_lib/ip/ble/hl/inc" "driver/ble/ble_lib/ip/ble/hl/api" "driver/ble/ble_lib/ip/ble/hl/src/gap/gapc" "driver/ble/ble_lib/ip/ble/hl/src/gap/gapm" "driver/ble/ble_lib/ip/ble/hl/src/gap/smpc" "driver/ble/ble_lib/ip/ble/hl/src/gap/smpm" "driver/ble/ble_lib/ip/ble/hl/src/gap" "driver/ble/ble_lib/ip/ble/hl/src/gatt/attc" "driver/ble/ble_lib/ip/ble/hl/src/gatt/attm" "driver/ble/ble_lib/ip/ble/hl/src/gatt/atts" "driver/ble/ble_lib/ip/ble/hl/src/gatt" "driver/ble/ble_lib/ip/ble/hl/src/gatt/gattc" "driver/ble/ble_lib/ip/ble/hl/src/gatt/gattm" "driver/ble/ble_lib/ip/ble/hl/src/l2c/l2cc" "driver/ble/ble_lib/ip/ble/hl/src/l2c/l2cm" "driver/ble/ble_lib/ip/ble/ll/src/rwble" "driver/ble/ble_lib/ip/ble/ll/src/lld" "driver/ble/ble_lib/ip/ble/ll/src/em" "driver/ble/ble_lib/ip/ble/ll/src/llm" "driver/ble/ble_lib/ip/ble/ll/src/llc" "driver/ble/ble_lib/ip/em/api" "driver/ble/ble_lib/ip/ea/api" "driver/ble/ble_lib/ip/hci/api" "driver/ble/ble_lib/ip/hci/src" "driver/ble/ble_lib/ip/ahi/api" "driver/ble/ble_lib/modules/ke/api" "driver/ble/ble_lib/modules/ke/src" "driver/ble/ble_lib/modules/h4tl/api" "func/include" "func/rf_test" "func/user_driver" "func/power_save" "func/uart_debug" "func/ethernet_intf" "func/hostapd-2.5/hostapd" "func/hostapd-2.5/bk_patch" "func/hostapd-2.5/src/utils" "func/hostapd-2.5/src/ap" "func/hostapd-2.5/src/common" "func/hostapd-2.5/src/drivers" "func/hostapd-2.5/src" "func/lwip_intf/lwip-2.0.2" "func/lwip_intf/lwip-2.0.2/src" "func/lwip_intf/lwip-2.0.2/port" "func/lwip_intf/lwip-2.0.2/src/include" "func/lwip_intf/lwip-2.0.2/src/include/netif" "func/lwip_intf/lwip-2.0.2/src/include/lwip" "func/temp_detect" "func/spidma_intf" "func/rwnx_intf" "func/joint_up" "func/tuya_pwm" "os/include" "os/FreeRTOSv9.0.0/FreeRTOS/Source/portable/Keil/ARM968es" "os/FreeRTOSv9.0.0/FreeRTOS/Source/include" "os/FreeRTOSv9.0.0")
list(APPEND ASM "driver/entry/boot_handlers.S" "driver/entry/boot_vectors.S")

set_source_files_properties(${SOURCES} PROPERTIES COMPILE_FLAGS "-g -mthumb -mcpu=arm968e-s -march=armv5te -mthumb-interwork -mlittle-endian -Os -std=c99 -ffunction-sections -Wall -fsigned-char -fdata-sections -Wunknown-pragmas -nostdlib -Wno-unused-function -Wno-unused-but-set-variable")
set_source_files_properties(${SOURCES_RTOS} PROPERTIES COMPILE_FLAGS "-g -marm -mcpu=arm968e-s -march=armv5te -mthumb-interwork -mlittle-endian -Os -std=c99 -ffunction-sections -Wall -fsigned-char -fdata-sections -Wunknown-pragmas")
set_source_files_properties(${ASM} PROPERTIES COMPILE_FLAGS "-g -marm -mthumb-interwork -mcpu=arm968e-s -march=armv5te -x assembler-with-cpp")

function(add_bk_encrypt BIN_NAME)
    add_custom_command(
            OUTPUT ${BIN_NAME}_enc.bin
            COMMAND ${ENCRYPT} ${BIN_NAME}.bin 510fb093 a3cbeadc 5993a17e c7adeb03 10000
            COMMAND ${CMAKE_COMMAND} -E rm ${BIN_NAME}.cpr ${BIN_NAME}.out
            DEPENDS ${BIN_NAME}.bin
    )
endfunction()

function(add_bk_packager BIN_NAME)
    add_custom_command(
            OUTPUT ${BIN_NAME}_UA.bin
            COMMAND ${BK_PACKAGER} -b ${PLATFORMS}/bk7231t_bootloader_enc.bin -f ${BIN_NAME}_enc.bin
            COMMAND ${CMAKE_COMMAND} -E rename ${BIN_NAME}_enc_uart_1M.bin ${BIN_NAME}_UA.bin
            DEPENDS ${BIN_NAME}_enc.bin
    )
    add_custom_command(
            OUTPUT ${BIN_NAME}_QIO.bin
            COMMAND ${CMAKE_COMMAND} -E rename all_1M.bin ${BIN_NAME}_QIO.bin
            DEPENDS ${BIN_NAME}_UA.bin
    )
endfunction()

function(add_ota_package BIN_NAME APP_VERSION)
    add_custom_command(
            OUTPUT ${BIN_NAME}.rbl
            COMMAND ${OTA_PACK_RT} -f ${BIN_NAME}.bin -v ${APP_VERSION} -o ${BIN_NAME}.rbl -p app -c gzip -s aes -k 0123456789ABCDEF0123456789ABCDEF -i 0123456789ABCDEF
            DEPENDS ${BIN_NAME}.bin
    )
    add_custom_command(
            OUTPUT ${BIN_NAME}_UG.bin
            COMMAND ${OTA_PACK_TY} ${BIN_NAME}.rbl ${BIN_NAME}_UG.bin ${APP_VERSION}
            DEPENDS ${BIN_NAME}.rbl
    )
endfunction()

add_library(bk7231t_sdk STATIC ${SOURCES} ${SOURCES_RTOS} ${ASM})
target_include_directories(bk7231t_sdk PUBLIC ${INCLUDES} ${CMAKE_CURRENT_BINARY_DIR})
target_link_libraries(
        bk7231t_sdk PUBLIC
        ${CMAKE_CURRENT_SOURCE_DIR}/lib/libble.a
        ${CMAKE_CURRENT_SOURCE_DIR}/lib/librwnx.a
        ${CMAKE_CURRENT_BINARY_DIR}/libbk7231t_sdk.a
)
